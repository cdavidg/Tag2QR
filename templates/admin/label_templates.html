{% extends "admin/base.html" %}

{% block title %}Plantillas de Etiquetas - Tag2QR{% endblock %}

{% block head %}
<style>
/* Dashboard Header */
.dashboard-header {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header-content {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
}

.header-title {
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-title i {
    font-size: 2.5rem;
    color: #0066cc;
}

.header-title h2 {
    margin: 0;
    font-size: 1.75rem;
    color: #333;
}

.header-title p {
    margin: 5px 0 0 0;
    font-size: 0.95rem;
    color: #666;
}

.header-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* Grid de configuración */
.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.config-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.preview-column {
    position: sticky;
    top: 20px;
    align-self: start;
}

/* Estilos para el formulario de configuración */
.label-config-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
}

.config-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    height: fit-content;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
}

.section-header i {
    font-size: 1.5rem;
}

.section-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
}

.form-control, .form-select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

.form-control:focus, .form-select:focus {
    outline: none;
    border-color: #0066cc;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
}

.input-group {
    display: flex;
    gap: 0;
}

.input-group .form-control {
    border-right: none;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.input-group-text {
    padding: 0.5rem 1rem;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-left: none;
    border-top-right-radius: 4px;
    border-bottom-right-radius: 4px;
    color: #666;
}

.form-check {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 1rem;
}

.form-check-input {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.form-check-label {
    cursor: pointer;
    margin: 0;
}

.color-picker-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

input[type="color"] {
    width: 60px;
    height: 38px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
}

input[type="color"]:hover {
    border-color: #0066cc;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    transition: all 0.2s;
}

.btn-primary {
    background: #0066cc;
    color: white;
}

.btn-primary:hover {
    background: #0052a3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-outline-secondary {
    background: white;
    color: #6c757d;
    border: 1px solid #6c757d;
}

.btn-outline-secondary:hover {
    background: #6c757d;
    color: white;
}

.btn-lg {
    padding: 1rem 2rem;
    font-size: 1.1rem;
}

.d-grid {
    display: grid;
}

.gap-2 {
    gap: 0.5rem;
}

/* Vista previa */
.preview-box {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
}

.preview-label {
    display: inline-block;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Responsive */
@media (max-width: 1200px) {
    .config-grid {
        grid-template-columns: 1fr;
    }
    
    .preview-column {
        position: static;
    }
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .header-actions {
        width: 100%;
    }
    
    .header-actions .btn {
        flex: 1;
    }
    
    .config-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .dashboard-header {
        padding: 15px;
    }
    
    .header-title i {
        font-size: 2rem;
    }
    
    .header-title h2 {
        font-size: 1.5rem;
    }
}

@media (max-width: 480px) {
    .label-config-container {
        padding: 10px;
    }
    
    .config-section {
        padding: 15px;
    }
    
    .header-actions {
        flex-direction: column;
    }
    
    .header-actions .btn {
        width: 100%;
    }
}

.specs-table {
    width: 100%;
    margin-top: 20px;
}

.specs-table tr {
    border-bottom: 1px solid #dee2e6;
}

.specs-table th {
    text-align: left;
    padding: 10px;
    font-weight: 600;
    color: #666;
}

.specs-table td {
    padding: 10px;
    color: #333;
}

.alert {
    padding: 1rem;
    border-radius: 4px;
    margin-top: 1rem;
}

.alert-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}

/* Responsive */
@media (max-width: 768px) {
    .label-config-container {
        padding: 10px;
    }
    
    .preview-container {
        position: static;
        margin-top: 20px;
    }
}

/* Grid de 2 columnas */
.row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

@media (max-width: 1024px) {
    .row {
        grid-template-columns: 1fr;
    }
}

.col-left, .col-right {
    min-width: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="label-config-container">
    <!-- Header Dashboard -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-title">
                <i class="fas fa-tags"></i>
                <div>
                    <h2>Plantillas de Etiquetas</h2>
                    <p>Configura el diseño de las etiquetas QR para tu impresora térmica</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                {% if sample_product %}
                <a href="{{ url_for('qr.print_ticket', product_id=sample_product.id) }}" 
                   target="_blank" 
                   class="btn btn-secondary">
                    <i class="fas fa-print"></i> Vista Previa
                </a>
                {% endif %}
                <button type="submit" form="labelForm" class="btn btn-primary">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
    
    <form method="POST" action="{{ url_for('store.label_templates') }}" id="labelForm">
        {{ form.hidden_tag() }}
        
        <div class="config-grid">
            <!-- Columna Izquierda: Formato y Dimensiones -->
            <div class="config-column">
                <!-- Tipo de Plantilla -->
                <div class="config-section">
                    <div class="section-header">
                        <i class="fas fa-shapes" style="color: #0066cc;"></i>
                        <h3>Formato de Etiqueta</h3>
                    </div>
                    <div class="form-group">
                        {{ form.label_template.label(class="form-label") }}
                        {{ form.label_template(class="form-select", id="templateType") }}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            {{ form.label_width.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.label_width(class="form-control", id="labelWidth") }}
                                <span class="input-group-text">mm</span>
                            </div>
                        </div>
                        <div class="form-group">
                            {{ form.label_height.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.label_height(class="form-control", id="labelHeight") }}
                                <span class="input-group-text">mm</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        {{ form.label_padding.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.label_padding(class="form-control", id="labelPadding") }}
                            <span class="input-group-text">mm</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        {{ form.label_qr_size.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.label_qr_size(class="form-control", id="qrSize") }}
                            <span class="input-group-text">%</span>
                        </div>
                        <small style="color: #666; font-size: 0.875rem;">Tamaño del código QR como porcentaje del ancho</small>
                    </div>
                </div>
                
                <!-- Contenido Visible -->
                <div class="config-section">
                    <div class="section-header">
                        <i class="fas fa-eye" style="color: #28a745;"></i>
                        <h3>Contenido Visible</h3>
                    </div>
                    <div class="form-check">
                        {{ form.label_show_store_name(class="form-check-input", id="showStoreName") }}
                        {{ form.label_show_store_name.label(class="form-check-label") }}
                    </div>
                    <div class="form-check">
                        {{ form.label_show_product_name(class="form-check-input", id="showProductName") }}
                        {{ form.label_show_product_name.label(class="form-check-label") }}
                    </div>
                    <div class="form-check">
                        {{ form.label_show_logo(class="form-check-input", id="showLogo") }}
                        {{ form.label_show_logo.label(class="form-check-label") }}
                    </div>
                    <div class="form-check">
                        {{ form.label_show_price(class="form-check-input", id="showPrice") }}
                        {{ form.label_show_price.label(class="form-check-label") }}
                    </div>
                    <div class="form-check">
                        {{ form.label_show_sku(class="form-check-input", id="showSku") }}
                        {{ form.label_show_sku.label(class="form-check-label") }}
                    </div>
                    <div class="form-check">
                        {{ form.label_show_description(class="form-check-input", id="showDescription") }}
                        {{ form.label_show_description.label(class="form-check-label") }}
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        {{ form.label_font_size.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.label_font_size(class="form-control", id="fontSize") }}
                            <span class="input-group-text">pt</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Columna Centro: Estilos -->
            <div class="config-column">
                <!-- Borde -->
                <div class="config-section">
                    <div class="section-header">
                        <i class="fas fa-border-style" style="color: #17a2b8;"></i>
                        <h3>Configuración del Borde</h3>
                    </div>
                    <div class="form-check">
                        {{ form.label_border(class="form-check-input", id="showBorder") }}
                        {{ form.label_border.label(class="form-check-label") }}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            {{ form.label_border_width.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.label_border_width(class="form-control", id="borderWidth") }}
                                <span class="input-group-text">px</span>
                            </div>
                        </div>
                        <div class="form-group">
                            {{ form.label_border_color.label(class="form-label") }}
                            <div class="color-picker-group">
                                {{ form.label_border_color(class="form-control", type="color", id="borderColor") }}
                                {{ form.label_border_color(class="form-control", placeholder="#000000", style="flex: 1;", id="borderColorHex") }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Colores -->
                <div class="config-section">
                    <div class="section-header">
                        <i class="fas fa-palette" style="color: #ffc107;"></i>
                        <h3>Colores</h3>
                    </div>
                    <div class="form-group">
                        {{ form.label_background_color.label(class="form-label") }}
                        <div class="color-picker-group">
                            {{ form.label_background_color(class="form-control", type="color", id="bgColor") }}
                            {{ form.label_background_color(class="form-control", placeholder="#FFFFFF", style="flex: 1;", id="bgColorHex") }}
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form.label_text_color.label(class="form-label") }}
                        <div class="color-picker-group">
                            {{ form.label_text_color(class="form-control", type="color", id="textColor") }}
                            {{ form.label_text_color(class="form-control", placeholder="#000000", style="flex: 1;", id="textColorHex") }}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Columna Derecha: Vista Previa -->
            <div class="config-column preview-column">
                <!-- Vista Previa -->
                <div class="config-section preview-box">
                    <div style="display: flex; justify-content: center; align-items: center; min-height: 350px;">
                        
                        <!-- Rectangular -->
                            {% if store.label_template == 'rectangular' or not store.label_template %}
                            <div style="
                                width: {{ store.label_width or 80 }}mm;
                                height: {{ store.label_height or 50 }}mm;
                                background-color: {{ store.label_background_color or '#FFFFFF' }};
                                color: {{ store.label_text_color or '#000000' }};
                                {% if store.label_border %}
                                border: {{ store.label_border_width or 2 }}px solid {{ store.label_border_color or '#000000' }};
                                {% endif %}
                                padding: {{ store.label_padding or 5 }}mm;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                            ">
                                <div style="flex-shrink: 0;">
                                    <div style="width: 100px; height: 100px; background: #ddd; display: flex; align-items: center; justify-content: center; border: 1px solid #999;">
                                        <i class="fas fa-qrcode fa-3x"></i>
                                    </div>
                                </div>
                                <div style="flex: 1; font-size: {{ store.label_font_size or 12 }}pt;">
                                    {% if store.label_show_logo != False %}
                                    <strong>{{ store.store_name }}</strong><br>
                                    {% endif %}
                                    {% if store.label_show_sku != False %}
                                    <small>SKU: EJEMPLO</small><br>
                                    {% endif %}
                                    {% if store.label_show_price != False %}
                                    <strong>$99.99</strong><br>
                                    {% endif %}
                                    {% if store.label_show_description != False %}
                                    <small>Descripción del producto</small>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Square -->
                            {% if store.label_template == 'square' %}
                            <div style="
                                width: {{ store.label_width or 60 }}mm;
                                height: {{ store.label_width or 60 }}mm;
                                background-color: {{ store.label_background_color or '#FFFFFF' }};
                                color: {{ store.label_text_color or '#000000' }};
                                {% if store.label_border %}
                                border: {{ store.label_border_width or 2 }}px solid {{ store.label_border_color or '#000000' }};
                                {% endif %}
                                padding: {{ store.label_padding or 5 }}mm;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                text-align: center;
                                gap: 8px;
                                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                            ">
                                <div style="width: 80px; height: 80px; background: #ddd; display: flex; align-items: center; justify-content: center; border: 1px solid #999;">
                                    <i class="fas fa-qrcode fa-3x"></i>
                                </div>
                                <div style="font-size: {{ store.label_font_size or 10 }}pt;">
                                    {% if store.label_show_logo != False %}
                                    <strong>{{ store.store_name }}</strong><br>
                                    {% endif %}
                                    {% if store.label_show_price != False %}
                                    <strong>$99.99</strong>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Circular -->
                            {% if store.label_template == 'circular' %}
                            <div style="
                                width: {{ store.label_width or 60 }}mm;
                                height: {{ store.label_width or 60 }}mm;
                                border-radius: 50%;
                                background-color: {{ store.label_background_color or '#FFFFFF' }};
                                color: {{ store.label_text_color or '#000000' }};
                                {% if store.label_border %}
                                border: {{ store.label_border_width or 2 }}px solid {{ store.label_border_color or '#000000' }};
                                {% endif %}
                                padding: {{ store.label_padding or 5 }}mm;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                text-align: center;
                                gap: 5px;
                                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                            ">
                                <div style="width: 60px; height: 60px; background: #ddd; display: flex; align-items: center; justify-content: center; border: 1px solid #999; border-radius: 50%;">
                                    <i class="fas fa-qrcode fa-2x"></i>
                                </div>
                                <div style="font-size: {{ store.label_font_size or 8 }}pt;">
                                    {% if store.label_show_logo != False %}
                                    <strong>{{ store.store_name }}</strong>
                                    {% endif %}
                                    {% if store.label_show_price != False %}
                                    <br><strong>$99.99</strong>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                        </div>
                        
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Nota:</strong> Esta es una vista previa aproximada. 
                            El resultado final puede variar según tu impresora térmica.
                        </div>
                    </div>
                </div>
                
                <!-- Especificaciones -->
                <!-- Especificaciones -->
                <div class="config-section">
                    <div class="section-header">
                        <i class="fas fa-ruler" style="color: #6c757d;"></i>
                        <h3>Especificaciones</h3>
                    </div>
                    <table class="specs-table">
                        <tr>
                            <th>Formato:</th>
                            <td>{{ store.label_template|title or 'Rectangular' }}</td>
                        </tr>
                        <tr>
                            <th>Dimensiones:</th>
                            <td id="specDimensions">{{ store.label_width or 80 }}mm × {{ store.label_height or 50 }}mm</td>
                        </tr>
                        <tr>
                            <th>Tamaño QR:</th>
                            <td id="specQrSize">{{ store.label_qr_size or 40 }}% del ancho</td>
                        </tr>
                        <tr>
                            <th>Fuente:</th>
                            <td id="specFontSize">{{ store.label_font_size or 12 }}pt</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// QR de prueba (URL de ejemplo)
const TEST_QR_URL = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=';
const SAMPLE_DATA = 'https://ejemplo.com/producto/12345';

// Referencias a elementos
const previewContainer = document.querySelector('.preview-box > div');
const templateType = document.getElementById('templateType');
const labelWidth = document.getElementById('labelWidth');
const labelHeight = document.getElementById('labelHeight');
const labelPadding = document.getElementById('labelPadding');
const qrSize = document.getElementById('qrSize');
const showBorder = document.getElementById('showBorder');
const borderWidth = document.getElementById('borderWidth');
const borderColor = document.getElementById('borderColor');
const borderColorHex = document.getElementById('borderColorHex');
const bgColor = document.getElementById('bgColor');
const bgColorHex = document.getElementById('bgColorHex');
const textColor = document.getElementById('textColor');
const textColorHex = document.getElementById('textColorHex');
const showStoreName = document.getElementById('showStoreName');
const showProductName = document.getElementById('showProductName');
const showLogo = document.getElementById('showLogo');
const showPrice = document.getElementById('showPrice');
const showSku = document.getElementById('showSku');
const showDescription = document.getElementById('showDescription');
const fontSize = document.getElementById('fontSize');

// Sincronizar color pickers con inputs de texto
if (borderColor && borderColorHex) {
    borderColor.addEventListener('input', (e) => borderColorHex.value = e.target.value);
    borderColorHex.addEventListener('input', (e) => borderColor.value = e.target.value);
}
if (bgColor && bgColorHex) {
    bgColor.addEventListener('input', (e) => bgColorHex.value = e.target.value);
    bgColorHex.addEventListener('input', (e) => bgColor.value = e.target.value);
}
if (textColor && textColorHex) {
    textColor.addEventListener('input', (e) => textColorHex.value = e.target.value);
    textColorHex.addEventListener('input', (e) => textColor.value = e.target.value);
}

// Función para validar y ajustar el tamaño del QR
function validateQRSize() {
    const type = templateType?.value || 'rectangular';
    const qrPercent = parseInt(qrSize?.value) || 30;
    let maxPercent = 80; // Default
    
    if (type === 'rectangular') {
        maxPercent = 60; // En rectangular hay texto al lado
    } else {
        maxPercent = 80; // En square/circular hay más espacio
    }
    
    if (qrPercent > maxPercent) {
        qrSize.value = maxPercent;
    }
    
    qrSize.max = maxPercent;
}

// Función para actualizar la vista previa
function updatePreview() {
    validateQRSize(); // Validar primero
    
    const type = templateType?.value || 'rectangular';
    const width = labelWidth?.value || 80;
    const height = labelHeight?.value || 50;
    const padding = labelPadding?.value || 5;
    const qrPercent = qrSize?.value || 30;
    const hasBorder = showBorder?.checked !== false;
    const borderW = borderWidth?.value || 2;
    const borderC = borderColor?.value || '#000000';
    const bgC = bgColor?.value || '#FFFFFF';
    const textC = textColor?.value || '#000000';
    const fSize = fontSize?.value || 12;
    
    // Convertir mm a pixels (1mm = 3.7795px @ 96 DPI)
    const MM_TO_PX = 3.7795;
    const widthPx = width * MM_TO_PX;
    const heightPx = height * MM_TO_PX;
    const paddingPx = padding * MM_TO_PX;
    
    // Calcular tamaño del QR en pixels
    const qrPixelSize = Math.floor((widthPx * qrPercent) / 100);
    const qrUrl = TEST_QR_URL + encodeURIComponent(SAMPLE_DATA) + `&size=${qrPixelSize}x${qrPixelSize}`;
    
    // Contenido
    let content = '';
    
    if (type === 'rectangular') {
        // Calcular tamaño del QR en mm (igual que el backend)
        const qrSizeMm = (width * qrPercent) / 100;
        const qrSizePx = qrSizeMm * MM_TO_PX;
        
        content = `
            <div style="
                width: ${widthPx}px;
                height: ${heightPx}px;
                background-color: ${bgC};
                color: ${textC};
                ${hasBorder ? `border: ${borderW}px solid ${borderC};` : ''}
                padding: ${paddingPx}px;
                display: flex;
                gap: ${3 * MM_TO_PX}px;
                box-sizing: border-box;
                font-family: Arial, sans-serif;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            ">
                <div style="width: ${qrSizePx}px; height: ${qrSizePx}px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                    <img src="${qrUrl}" style="width: 100%; height: 100%; object-fit: contain; display: block;">
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; gap: ${2 * MM_TO_PX}px;">
                    ${showStoreName?.checked ? `<div style="font-size: ${fSize}pt; font-weight: bold;"><strong>Mi Tienda</strong></div>` : ''}
                    ${showProductName?.checked ? `<div style="font-size: ${fSize}pt; font-weight: bold;"">Producto de Ejemplo</div>` : ''}
                    ${showSku?.checked ? `<div style="font-size: ${fSize * 0.85}pt; color: #666;">SKU: EJEMPLO-001</div>` : ''}
                    ${showPrice?.checked ? `<div style="font-size: ${fSize * 1.2}pt; font-weight: bold;">$99.99</div>` : ''}
                    ${showDescription?.checked ? `<div style="font-size: ${fSize * 0.85}pt; line-height: 1.3;">Descripción del producto</div>` : ''}
                </div>
            </div>
        `;
    } else if (type === 'square') {
        // Calcular tamaño del QR en mm
        const qrSizeMm = (width * qrPercent) / 100;
        const qrSizePx = qrSizeMm * MM_TO_PX;
        
        content = `
            <div style="
                width: ${widthPx}px;
                height: ${widthPx}px;
                background-color: ${bgC};
                color: ${textC};
                ${hasBorder ? `border: ${borderW}px solid ${borderC};` : ''}
                padding: ${paddingPx}px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-between;
                box-sizing: border-box;
                font-family: Arial, sans-serif;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            ">
                <div style="width: ${qrSizePx}px; height: ${qrSizePx}px;">
                    <img src="${qrUrl}" style="width: 100%; height: 100%; object-fit: contain; display: block;">
                </div>
                <div style="font-size: ${fSize}pt; line-height: 1.2; text-align: center;">
                    ${showStoreName?.checked ? '<div style="font-weight: bold;">Mi Tienda</div>' : ''}
                    ${showProductName?.checked ? '<div>Producto</div>' : ''}
                    ${showPrice?.checked ? '<div style="font-weight: bold;">$99.99</div>' : ''}
                    ${showSku?.checked ? `<div style="font-size: ${fSize * 0.85}pt;">SKU-001</div>` : ''}
                </div>
            </div>
        `;
    } else { // circular
        // Calcular tamaño del QR en mm
        const qrSizeMm = (width * qrPercent) / 100;
        const qrSizePx = qrSizeMm * MM_TO_PX;
        
        content = `
            <div style="
                width: ${widthPx}px;
                height: ${widthPx}px;
                border-radius: 50%;
                background-color: ${bgC};
                color: ${textC};
                ${hasBorder ? `border: ${borderW}px solid ${borderC};` : ''}
                padding: ${paddingPx}px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                gap: ${2 * MM_TO_PX}px;
                box-sizing: border-box;
                font-family: Arial, sans-serif;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            ">
                <div style="width: ${qrSizePx}px; height: ${qrSizePx}px;">
                    <img src="${qrUrl}" style="width: 100%; height: 100%; object-fit: contain; display: block;">
                </div>
                <div style="font-size: ${Math.max(fSize - 2, 8)}pt; line-height: 1.1;">
                    ${showProductName?.checked ? '<div>Producto</div>' : ''}
                    ${showPrice?.checked ? '<div style="font-weight: bold;">$99.99</div>' : ''}
                    ${showStoreName?.checked ? '<div style="font-weight: bold;">Tienda</div>' : ''}
                    ${showSku?.checked ? `<div style="font-size: ${(fSize - 2) * 0.75}pt;">SKU-001</div>` : ''}
                </div>
            </div>
        `;
    }
    
    previewContainer.innerHTML = content;
    
    // Actualizar especificaciones
    document.getElementById('specDimensions').textContent = `${width}mm × ${height}mm`;
    document.getElementById('specQrSize').textContent = `${qrPercent}% del ancho`;
    document.getElementById('specFontSize').textContent = `${fSize}pt`;
}

// Event listeners para todos los campos
[templateType, labelWidth, labelHeight, labelPadding, qrSize, showBorder, borderWidth, 
 borderColor, bgColor, textColor, showStoreName, showProductName, showLogo, showPrice, 
 showSku, showDescription, fontSize].forEach(el => {
    if (el) {
        el.addEventListener('input', updatePreview);
        el.addEventListener('change', updatePreview);
    }
});

// Actualizar vista previa al cargar
document.addEventListener('DOMContentLoaded', updatePreview);
</script>
{% endblock %}
